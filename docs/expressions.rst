.. _expressions:

Expressions
-----------

Шаблонизатор поддерживает выражения, с помощью которых можно создавать сложные связи между формами или изменять значения
переменных "на лету", передавая их в параметр формы.

Ссылка на другой элемент шаблона
================================

Если у формы указать параметр ``id`` то можно будет ссылаться на его параметры из других форм.

.. note:: Форма должна быть определена до обращения к ней

Следующий пример показывает как создать простую зависимость второго прямоугольника от размера и положения первого:

.. code-block:: json

    {
      "shapes": [

        {
          "": "определяем первый прямоугольник",
          "type": "rect", "x": 0, "y": 0,
          "width": 100, "height": 100,
          "id": "rect_1"
        },

        {
          "": "определяем второй прямоугольник",
          "type": "rect",
          "": "параметр Х ссылается на такой же параметр другой формы.",
          "x": "rect_1.x",
          "": "параметр Y ссылается на параметр высоты другой формы",
          "y": "rect_1.height"
        }
      ]
    }

Для того чтобы ссылаться на свои параметры используйте специальное слово ``self``. Например ``"x": "self.y"``.

Ссылка на переменные
====================

С помощью символа ``$`` можно ссылаться на значения из контекста или специальные значения, которые генерируются шаблонизатором.

В этом примере мы ссылаемся на цвет из переменных контекста.

.. code-block:: json

    {
      "variables": {
        "backdrop_color": [0, 0, 0, 100]
      },
      "shapes": [
        {
          "type": "rect", "x": 0, "y": 0, "width": 100, "height": 100,
          "color": "$backdrop_color"
        }
      ]
    }

Ссылка на родительский объект
=============================

Любая форма имеет родительский объект. Если он не задан явно, то родительским объектом будет вся картинка.
Координаты рассчитываются относительно родительского объекта.

.. note:: Такие поля как ``left``, ``right``, ``top`` и ``bottom`` возвращают глобальные координаты вне зависимости от родительского объекта.

Для ссылки на параметры родительского объекта используйте имя ``parent``

.. note:: Нельзя создать форму указав ей параметр ``id`` равный ``"parent"`` или ``"self"``. Это зарезервированны слова.

В следующем примере для второй формы указан родительский объект. Параметр ``"width"`` ссылается на ширину родительского объекта.
Значение будет автоматиески изменться если изменить родительский объект.

.. code-block:: json

    {
      "shapes": [
        {
          "type": "rect", "x": 0, "y": 0,
          "width": 100, "height": 100,
          "id": "rec1"
        },
        {
          "type": "rect", "parent": "rec1",
          "x": 0, "y": 0,

          "":"указываем ширину равную ширине родительского объекта",
          "width": "parent.width",
          "height": 50
        }
      ]
    }


Сложные выражения
=================

Шаблонизатор поддерживает сложные выражения, которые транлируются в чистый Python, подставляя значения переменных.
Если в выражении есть какие-либо операции, а не только ссылка на другой параметр, то его следует начинать со знака ``=``.

В следующем шаблоне второй прмоугольник всегда в 2 раза меньше родителя и вписан в его центр.

.. code-block:: json

    {
      "shapes": [
        {
          "type": "rect",
          "x": 0, "y": 0,
          "width": 200, "height": 200,
          "id": "rec1"
        },
        {
          "type": "rect", "parent": "rec1",
          "x": 0, "y": 0,
          "align_h": "center", "align_v": "center",
          "width": "=parent.width/2", "height": "=parent.height/2",
          "color": "red"
        }
      ]
    }

В сложных выражениях можно точно так же использовать переменные.

**Внимание!** При распаковке переменных в место имени переменной подставляется её значение. Если вы пишете экспрешен со
строкой то нужно добавлять ковычки.

.. code-block:: json

    {
    "variables": {
        "name": "some_name"
        },
    "shapes": [
        {
            "type": "label", "text": "hello",
            "enabled": "='$name'=='name1'"
        }
        ]
    }

В этом примере переменная ``$name`` дополнительно брется в ковычки, чтобы она определилась как строка.

Специальные переменные
======================

Шаблонизатор автоматически добавляет в контекст несколько переменных

source
    Ссылка на исходное изображение, поверх которого производится рендер шаблона. С помощью этой переменной можно ссылаться
    на исходную картинку в форме ``image`` в параметре ``source``.

.. code-block:: json

    [
        {"type": "image", "source": "$source"}
    ]

source_width
    Ширина исходной картинки

source_height
    Высота иходной картинки

source_aspect
    Отношение высоты исходной кратинки к её ширине `(height/width)`

unit
    Одна сотая от высоты картинки. Может использоваться как множитель к числам

Unit
====

В выражениях есть возможность записывать числа в виде относительного размера от высоты картинки.
Это значение доступно в под именем ``"$unit"``.
Значение `unit` является короткой записью выражения ``source_height / 100``, то есть одна сотая часть от высоты
исходного выизображения, или один процент.

Этот параметр можно использовать в записи чисел в виде суффикса "u". Например: ``10u``, ``2.5u``, ``50u``.

.. code-block:: json

    [
        {"type": "label", "text": "$unit", "font_size": "10u"}
    ]

Данный код создаст текст в котором будет записан размер одного "юнита" в пикселях.
Высота этого текста всегда будет 10% от высоты картинки.

Этот способ полезно использовать для адаптивных шаблонов, которые могут рендериться на картинках разного размера.
